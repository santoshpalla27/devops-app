# ==================== PARSE JSON ====================

# Parse incoming JSON
[FILTER]
    Name          parser
    Match         app.raw
    Key_Name      log
    Parser        json
    Reserve_Data  On
    Preserve_Key  Off

[FILTER]
    Name          parser
    Match         docker.raw
    Key_Name      log
    Parser        docker
    Reserve_Data  On
    Preserve_Key  Off

# ==================== FIELD NORMALIZATION ====================

# Add ingest timestamp
[FILTER]
    Name          modify
    Match         *
    Add           ingest_time ${FLUENT_BIT_TIMESTAMP}

# Normalize timestamp field to @timestamp
[FILTER]
    Name          modify
    Match         *
    Rename        timestamp @timestamp
    Rename        time @timestamp

# Normalize log level
[FILTER]
    Name          modify
    Match         *
    Rename        level log.level
    Rename        severity log.level

# Normalize service name
[FILTER]
    Name          modify
    Match         *
    Rename        service service.name
    Rename        app service.name
    Rename        application service.name

# Add host name
[FILTER]
    Name          modify
    Match         *
    Add           host.name ${HOSTNAME}

# Add environment
[FILTER]
    Name          modify
    Match         *
    Set           environment ${ENVIRONMENT}

# ==================== VALIDATION ====================

# Check for required fields
[FILTER]
    Name          lua
    Match         *
    script        /fluent-bit/etc/validate.lua
    call          validate_log

# ==================== ROUTING BY EVENT TYPE ====================

# Route application logs
[FILTER]
    Name          rewrite_tag
    Match         app.raw
    Rule          $event_type ^(APP_|HTTP_|CONNECTOR_|SCHEDULER_|METRIC_) logs.application.$TAG true
    Emitter_Name  re_emitted_app

# Route audit logs (policy changes, CRUD operations)
[FILTER]
    Name          rewrite_tag
    Match         app.raw
    Rule          $event_type ^(POLICY_CREATED|POLICY_UPDATED|POLICY_DELETED|SECURITY_AUDIT) logs.audit.$TAG true
    Emitter_Name  re_emitted_audit

# Route chaos events
[FILTER]
    Name          rewrite_tag
    Match         app.raw
    Rule          $event_type ^(CHAOS_|RECOVERY_) logs.chaos.$TAG true
    Emitter_Name  re_emitted_chaos

# Route security events
[FILTER]
    Name          rewrite_tag
    Match         app.raw
    Rule          $event_type ^(SECURITY_|AUTH_) logs.security.$TAG true
    Emitter_Name  re_emitted_security

# Default: application logs for unmatched
[FILTER]
    Name          rewrite_tag
    Match         app.raw
    Rule          $event_type .* logs.application.$TAG false
    Emitter_Name  re_emitted_default

# Route invalid logs to DLQ
[FILTER]
    Name          rewrite_tag
    Match         *
    Rule          $_valid ^false$ logs.dlq.$TAG true
    Emitter_Name  re_emitted_dlq

# ==================== CLEANUP ====================

# Remove internal fields before sending to ES
[FILTER]
    Name          modify
    Match         logs.*
    Remove        _valid
    Remove        _validation_error
