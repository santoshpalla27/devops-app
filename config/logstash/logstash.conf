input {
  # Kafka input for application events
  kafka {
    bootstrap_servers => "kafka:9092"
    topics => ["controlplane-events", "state-transitions", "chaos-events"]
    group_id => "logstash-consumer"
    codec => json
    decorate_events => true
  }

  # TCP input for direct logging
  tcp {
    port => 5000
    codec => json_lines
  }

  # Beats input for Filebeat
  beats {
    port => 5044
  }
}

filter {
  # Parse timestamp
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
    target => "@timestamp"
  }

  # Add metadata
  mutate {
    add_field => {
      "[@metadata][index_prefix]" => "controlplane"
    }
  }

  # Route to different indices based on event type
  if [event_type] {
    mutate {
      add_field => { "[@metadata][index_prefix]" => "%{event_type}" }
    }
  }

  # Parse log level
  if [level] {
    mutate {
      lowercase => ["level"]
    }
  }

  # GeoIP lookup for client IPs (if present)
  if [client_ip] and [client_ip] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/ {
    geoip {
      source => "client_ip"
      target => "geoip"
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{+YYYY.MM.dd}"
    document_id => "%{[event_id]}"
    action => "index"
  }

  # Debug output (disable in production)
  # stdout { codec => rubydebug }
}
