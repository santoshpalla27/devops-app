name: chaos_latency_injection
description: Validates deep chaos latency injection and full control-plane recovery loop
timeout: 300

preconditions:
  - mysql.state == CONNECTED
  - mysql.latency < 100

actions:
  - type: REST
    method: POST
    endpoint: /api/chaos/inject
    payload:
      systemType: mysql
      faultType: LATENCY_INJECTION
      durationSeconds: 120
  
  - type: WAIT
    duration: 15s

expectations:
  states:
    - system: mysql
      final_state: CONNECTED
  
  policies:
    - policy_id: mysql-circuit-open-on-retries
      should_fire: false  # Should recover before circuit opens
  
  metrics:
    - name: controlplane_connection_retries
      labels: {system: mysql}
      threshold: "< 5"
  
  events:
    - type: RETRY_ATTEMPTED
      count: "> 0"
    - type: CONNECTION_ESTABLISHED
      count: 1

validation:
  - latency_spike_detected: true
  - recovery_successful: true
  - no_data_loss: true
